function GoogleService(e){self=this,clientId=e.clientId,clientSecret=e.clientSecret,redirectUri=e.redirectUri,devKey=e.devKey,Ti.API.debug("GoogleService object initialized")}function showAuthorizeUI(e){window=Ti.UI.createWindow({fullscreen:!0,width:"100%"}),webView=Ti.UI.createWebView({top:0,width:"100%",url:e,autoDetect:[Ti.UI.AUTODETECT_NONE]}),webView.addEventListener("beforeload",function(e){Ti.API.info("Preload: "+e.url+" : "+e.url.indexOf(redirectUri)),0===e.url.indexOf("http://localhost/?")?(webView.stopLoading(),authorizeUICallback(e)):-1!==e.url.indexOf("https://accounts.google.com/Logout")&&authorizeUICallback(e)}),webView.addEventListener("load",function(e){Ti.API.info("Load: "+e.url+" : "+e.url.indexOf(redirectUri)),-1!==e.url.indexOf("approval")&&authorizeUICallback(e)}),window.add(webView),window.addEventListener("androidback",function(){Ti.App.fireEvent("login_closed",{what:"google"}),saveHer.stopExecution=!1,window.close()}),window.open()}function destroyAuthorizeUI(){if(Ti.API.debug("destroyAuthorizeUI"),null!=window)try{webView.removeEventListener("load",authorizeUICallback),window.close(),Ti.App.fireEvent("close_login",{}),saveHer.stopExecution=!1}catch(e){Ti.API.error("Cannot destroy the authorize UI. Ignoring.")}}function getTokens(e,t){var i={call:"token",method:"POST",params:{client_id:clientId,client_secret:clientSecret,redirect_uri:redirectUri,grant_type:"authorization_code",code:e}};self.callMethod(i,function(e){Ti.API.info(e),e.success?t(e.data):Ti.API.error("Error getting tokens")},!0)}function authorizeUICallback(e){Ti.API.info("authorizeUILoaded "+e.type);var t,i=!1;if(0===e.url.indexOf("http://localhost/?")){Ti.API.info(e.url);var n=e.url.split("=")[1];i=!0,Ti.API.info("Temp Token: "+n)}else if(-1!==e.url.indexOf("approval")){Ti.API.info(e.url);var a=webView.evalJS("document.title"),n=a.split("=")[1];i=!0,Ti.API.info("Temp Token: "+n)}else 0===e.url.indexOf("https://accounts.google.com/Logout")&&(Ti.App.fireEvent("app:google_logout",{}),destroyAuthorizeUI(),Ti.App.Properties.setString("GG_ACCESS_TOKEN",null),Ti.App.Properties.setString("GG_REFRESH_TOKEN",null),success_callback(!1));i&&("access_denied"===n?(Ti.App.fireEvent("app:google_access_denied",{}),t=!1,Ti.App.Properties.setString("GG_ACCESS_TOKEN",null),Ti.App.Properties.setString("GG_REFRESH_TOKEN",null),void 0!=success_callback&&success_callback(t)):getTokens(n,function(e){var i=JSON.parse(e);Ti.API.debug(i),Ti.API.debug("Setting ACCESS_TOKEN: "+i.access_token),Ti.API.debug("Setting REFRESH_TOKEN: "+i.refresh_token),ACCESS_TOKEN=i.access_token,REFRESH_TOKEN=i.refresh_token,t=!0,Ti.App.Properties.setString("GG_ACCESS_TOKEN",ACCESS_TOKEN),Ti.App.Properties.setString("GG_REFRESH_TOKEN",REFRESH_TOKEN),Ti.App.fireEvent("app:google_token",{access_token:ACCESS_TOKEN,refresh_token:REFRESH_TOKEN}),void 0!=success_callback&&success_callback(t)}),destroyAuthorizeUI())}var clientId,clientSecret,redirectUri,responseType="code",accessType="offline",scope="https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email",state,devKey,ACCESS_TOKEN=null,REFRESH_TOKEN=null,xhr=null,OAUTH_URL="https://accounts.google.com/o/oauth2/",API_URL="https://www.googleapis.com/oauth2/v1/",success_callback=null,window=null,inSimulator=-1!==Ti.Platform.model.indexOf("Simulator")||"x86_64"==Ti.Platform.model||"google_sdk"==Ti.Platform.model,self;GoogleService.prototype.accessToken=function(){return Ti.App.Properties.getString("GG_ACCESS_TOKEN")},GoogleService.prototype.refreshToken=function(e){if(!REFRESH_TOKEN)return null;var t={call:"token",method:"POST",params:{client_id:clientId,client_secret:clientSecret,refresh_token:REFRESH_TOKEN,grant_type:"refresh_token"}};self.callMethod(t,function(t){Ti.API.info("[refreshToken] "+t),t.success?(Ti.API.info("[refreshToken] "+JSON.parse(t.data).access_token),ACCESS_TOKEN=JSON.parse(t.data).access_token,Ti.App.Properties.setString("GG_ACCESS_TOKEN",ACCESS_TOKEN),e({success:!0,token:ACCESS_TOKEN})):(Ti.API.error("Error getting tokens"),e({success:!1,token:null}))},!0)},GoogleService.prototype.login=function(e){if(Ti.App.Properties.removeProperty("GG_ACCESS_TOKEN"),Ti.App.Properties.removeProperty("GG_REFRESH_TOKEN"),ACCESS_TOKEN=Ti.App.Properties.getString("GG_ACCESS_TOKEN"),REFRESH_TOKEN=Ti.App.Properties.getString("GG_REFRESH_TOKEN"),Ti.API.info("GoogleService login "+ACCESS_TOKEN),null!==ACCESS_TOKEN)return ACCESS_TOKEN=Ti.App.Properties.getString("GG_ACCESS_TOKEN"),success_callback=e,void e(!0);void 0!==e&&(success_callback=e);var t=String.format(OAUTH_URL+"auth?client_id=%s&redirect_uri=%s&scope=%s&response_type=%s&access_type=%s",clientId,redirectUri,scope,responseType,accessType);Ti.API.info(t),showAuthorizeUI(t)},GoogleService.prototype.callMethod=function(e,t,i){var n=e.params,a=e.method,r=e.call,o="";try{if(xhr||(xhr=Titanium.Network.createHTTPClient()),n&&"GET"===a){for(var s in n)o+="&"+Titanium.Network.encodeURIComponent(s)+"="+Titanium.Network.encodeURIComponent(n[s]);var l=API_URL+r+"?access_token="+ACCESS_TOKEN+"&alt=json&v=2&key="+devKey+o;Ti.API.info(l),xhr.open("GET",l)}else"POST"===a&&(i?xhr.open("POST",OAUTH_URL+r):xhr.open("POST",API_URL+r+"?alt=json&v=2&access_token="+ACCESS_TOKEN+"&key="+devKey));xhr.onerror=function(e){Ti.API.error("GoogleService ERROR "+e.error),Ti.API.error("GoogleService ERROR "+e),t&&t({error:e,success:!1})},xhr.onload=function(){t&&t({error:null,success:!0,data:xhr.responseText})},"POST"===a?xhr.send(n):xhr.send()}catch(u){Titanium.UI.createAlertDialog({title:"Error",message:String(u),buttonNames:["OK"]}).show()}},exports.GoogleService=GoogleService;