function Listeners(){var imagefactory=require("ti.imagefactory"),Compression=require("ti.compression"),Questionnaire=require("ui/tablet/pages/Questionnaire"),self={};return self.sendRestoredReport=function(button,path,parsed,preview,customCombo,currentPath){button.setButtonTitle("Attendi...");var zipelements=[];""!=parsed.img1&&(zipelements[0]=parsed.img1),""!=parsed.img2&&(zipelements[1]=parsed.img2),""!=parsed.img3&&(zipelements[2]=parsed.img3);var zipfile=Ti.Filesystem.getFile(currentPath+"/report.zip"),toDelete=Ti.Filesystem.getFile(currentPath),zipfilepath=zipfile.getNativePath(),result=Compression.zip(zipfilepath,zipelements);if("success"==result){if(!zipfile.exists()){var dialog=Ti.UI.createAlertDialog({message:"C'è stato un errore nella costruzione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();return button.setButtonTitle("Invia"),void(saveHer.stopExecution=!1)}var request=Titanium.Network.createHTTPClient({onload:function(){var e=JSON.parse(this.responseText);if(!e.response){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return button.setButtonTitle("Invia"),zipfile.deleteFile(),customCombo.reloadCombo(),void(saveHer.stopExecution=!1)}var t=e.lastid;toDelete.deleteDirectory(!0),setTimeout(function(){(new Questionnaire).openWin(t,Ti.App.Properties.getString("nickname")),toDelete.deleteFile(),preview.resetReport(),customCombo.reloadCombo(),saveHer.stopExecution=!1},3e3),Ti.API.info(this.responseText)},onerror:function(){Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();button.setButtonTitle("Invia"),zipfile.deleteFile(),customCombo.reloadCombo(),saveHer.stopExecution=!1}});if(Titanium.Network.getOnline()){var url="http://maps.google.com/maps/api/geocode/json?latlng="+parsed.latitude+","+parsed.longitude+"&sensor=true",xhr=Titanium.Network.createHTTPClient();xhr.open("GET",url),xhr.onload=function(){var json=this.responseText,gotitems=eval("("+json+")");""!=gotitems.results&&(parsed.address=gotitems.results[0].address_components[2].long_name),Ti.API.info("Indirizzo "+parsed.address),request.open("POST","http://www.appsaveheritage.com/rep.php");var prms={nick:Ti.App.Properties.getString("nickname"),zip:zipfile.read(),latitude:parsed.latitude,longitude:parsed.longitude};Ti.API.info(JSON.stringify(prms)),request.send(prms)},xhr.onerror=function(){request.open("POST","http://www.appsaveheritage.com/rep.php");var e={nick:Ti.App.Properties.getString("nickname"),zip:zipfile.read(),latitude:parsed.latitude,longitude:parsed.longitude};Ti.API.info(JSON.stringify(e)),request.send(e)},xhr.send()}}},self.sendReport=function(e,t,i){var a=[];e.setButtonTitle("Attendi...");try{var o=Titanium.Filesystem.getFile("appdata://reports");o.exists()||o.createDirectory();var r=Titanium.Filesystem.getFile(o.getNativePath()+"/tmp");r.createDirectory();var n=null,s=null;t.isFirstImagePresent()&&(n=Titanium.Filesystem.getFile(r.getNativePath()+"/1.jpg"),s=imagefactory.compress(t.getFirstBigLayer(),.15),n.write(s),a[0]=n.getNativePath()),t.isSecondImagePresent()&&(n=Titanium.Filesystem.getFile(r.getNativePath()+"/2.jpg"),s=imagefactory.compress(t.getSecondBigLayer(),.15),n.write(s),a[1]=n.getNativePath()),t.isThirdImagePresent()&&(n=Titanium.Filesystem.getFile(r.getNativePath()+"/3.jpg"),s=imagefactory.compress(t.getThirdBigLayer(),.15),n.write(s),a[2]=n.getNativePath())}catch(l){Ti.API.info(l);{Ti.UI.createAlertDialog({message:"Sembra ci sia stato un problema nella memorizzazione dei files. Controlla lo spazio libero sulla tua SDCard.",ok:"Ok",title:"saveHer"}).show()}return void(saveHer.stopExecution=!1)}var c=Ti.Filesystem.getFile(o.getNativePath()+"/report.zip"),d=c.getNativePath(),u=Compression.zip(d,a);if("success"!=u){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'elaborazione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),r.deleteDirectory(!0),void(saveHer.stopExecution=!1)}if(!c.exists()){{Ti.UI.createAlertDialog({message:"C'è stato un errore nella costruzione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),void(saveHer.stopExecution=!1)}var f=Titanium.Network.createHTTPClient({onload:function(){var t=JSON.parse(this.responseText);if(!t.response){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),r.deleteDirectory(!0),c.deleteFile(),void(saveHer.stopExecution=!1)}var i=t.lastid;0==i&&(i=1),r.deleteDirectory(!0),c.deleteFile(),setTimeout(function(){(new Questionnaire).openWin(i,Ti.App.Properties.getString("nickname"))},3e3)},onerror:function(){Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();e.setButtonTitle("Invia"),r.deleteDirectory(!0),c.deleteFile(),saveHer.stopExecution=!1}});f.open("POST","http://www.appsaveheritage.com/rep.php");var p={nick:Ti.App.Properties.getString("nickname"),zip:c.read(),latitude:i.getLat(),longitude:i.getLon()};f.send(p)},self}module.exports=Listeners;