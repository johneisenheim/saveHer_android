function Listeners(){var imagefactory=require("ti.imagefactory"),Compression=require("ti.compression"),Questionnaire=require("ui/handheld/pages/Questionnaire"),MainPage=require("ui/handheld/pages/MainPage"),self={};return self.sendRestoredReport=function(status,path,parsed,preview,customCombo,currentPath){status.text="Attendi...";var zipelements=[];""!=parsed.img1&&(zipelements[0]=parsed.img1),""!=parsed.img2&&(zipelements[1]=parsed.img2),""!=parsed.img3&&(zipelements[2]=parsed.img3);var zipfile=Ti.Filesystem.getFile(currentPath+"/report.zip"),toDelete=Ti.Filesystem.getFile(currentPath),zipfilepath=zipfile.getNativePath(),result=Compression.zip(zipfilepath,zipelements);if("success"==result){if(!zipfile.exists()){var dialog=Ti.UI.createAlertDialog({message:"C'è stato un errore nella costruzione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();return status.text="",void(saveHer.stopExecution=!1)}var request=Titanium.Network.createHTTPClient({onload:function(){var e=JSON.parse(this.responseText);if(!e.response){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return status.text="",zipfile.deleteFile(),customCombo.reloadCombo(),void(saveHer.stopExecution=!1)}var t=e.lastid;toDelete.deleteDirectory(!0),setTimeout(function(){(new Questionnaire).openWin(t,Ti.App.Properties.getString("nickname")),preview.resetReport(),customCombo.reloadCombo(),Ti.App.fireEvent("reload_circle",{}),saveHer.stopExecution=!1},3e3),Ti.API.info(this.responseText)},onerror:function(){Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();status.text="",zipfile.deleteFile(),customCombo.reloadCombo(),saveHer.stopExecution=!1}});if(Titanium.Network.getOnline()){var url="http://maps.google.com/maps/api/geocode/json?latlng="+parsed.latitude+","+parsed.longitude+"&sensor=true",xhr=Titanium.Network.createHTTPClient();xhr.open("GET",url),xhr.onload=function(){var json=this.responseText,gotitems=eval("("+json+")");if(""!=gotitems.results)try{parsed.address=gotitems.results[0].address_components[2].long_name}catch(ex){parsed.address=""}Ti.API.info("Indirizzo "+parsed.address),request.open("POST","http://www.appsaveheritage.com/rep.php");var prms={nick:Ti.App.Properties.getString("nickname"),zip:zipfile.read(),latitude:parsed.latitude,longitude:parsed.longitude};Ti.API.info(JSON.stringify(prms)),request.send(prms)},xhr.onerror=function(){request.open("POST","http://www.appsaveheritage.com/rep.php");var e={nick:Ti.App.Properties.getString("nickname"),zip:zipfile.read(),latitude:parsed.latitude,longitude:parsed.longitude};Ti.API.info(JSON.stringify(e)),request.send(e)},xhr.send()}}},self.sendReport=function(e,t,i){var a=[];e.setButtonTitle("Attendi...");try{var r=Titanium.Filesystem.getFile("appdata://reports");r.exists()||r.createDirectory();var o=Titanium.Filesystem.getFile(r.getNativePath()+"/tmp");o.createDirectory();var n=null,s=null;t.isFirstImagePresent()&&(n=Titanium.Filesystem.getFile(o.getNativePath()+"/1.jpg"),s=imagefactory.compress(t.getFirstBigLayer(),.15),n.write(s),a[0]=n.getNativePath()),t.isSecondImagePresent()&&(n=Titanium.Filesystem.getFile(o.getNativePath()+"/2.jpg"),s=imagefactory.compress(t.getSecondBigLayer(),.15),n.write(s),a[1]=n.getNativePath()),t.isThirdImagePresent()&&(n=Titanium.Filesystem.getFile(o.getNativePath()+"/3.jpg"),s=imagefactory.compress(t.getThirdBigLayer(),.15),n.write(s),a[2]=n.getNativePath())}catch(l){Ti.API.info(l);{Ti.UI.createAlertDialog({message:"Sembra ci sia stato un problema nella memorizzazione dei files. Controlla lo spazio libero sulla tua SDCard.",ok:"Ok",title:"saveHer"}).show()}return void(saveHer.stopExecution=!1)}var u=Ti.Filesystem.getFile(r.getNativePath()+"/report.zip"),c=u.getNativePath(),d=Compression.zip(c,a);if("success"!=d){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'elaborazione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),o.deleteDirectory(!0),void(saveHer.stopExecution=!1)}if(!u.exists()){{Ti.UI.createAlertDialog({message:"C'è stato un errore nella costruzione dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),void(saveHer.stopExecution=!1)}var g=Titanium.Network.createHTTPClient({onload:function(){var t=JSON.parse(this.responseText);if(!t.response){{Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show()}return e.setButtonTitle("Invia"),o.deleteDirectory(!0),u.deleteFile(),void(saveHer.stopExecution=!1)}var i=t.lastid;0==i&&(i=1),o.deleteDirectory(!0),u.deleteFile(),setTimeout(function(){(new Questionnaire).openWin(i,Ti.App.Properties.getString("nickname"))},3e3)},onerror:function(){Ti.UI.createAlertDialog({message:"C'è stato un errore nell'invio dei dati. Per favore, riprova!",ok:"Ok",title:"saveHer"}).show();e.setButtonTitle("Invia"),o.deleteDirectory(!0),u.deleteFile(),saveHer.stopExecution=!1}});g.open("POST","http://www.appsaveheritage.com/rep.php");var p={nick:Ti.App.Properties.getString("nickname"),zip:u.read(),latitude:i.getLat(),longitude:i.getLon()};g.send(p)},self.storeReport=function(networkRectangle,reportRectangle,location,gpsRectangle,self){if(!saveHer.stopExecution){if(saveHer.stopExecution=!0,networkRectangle.setButtonStatus("Attendi..."),!reportRectangle.isFirstImagePresent()&&!reportRectangle.isSecondImagePresent()&&!reportRectangle.isThirdImagePresent()){var dialog=Ti.UI.createAlertDialog({message:"Per inviare un report, per favore inserisci almeno una foto.",ok:"Ok",title:"saveHer"}).show();return networkRectangle.setButtonStatus("Memorizza"),void(saveHer.stopExecution=!1)}if(!Titanium.Filesystem.isExternalStoragePresent()){var dialog=Ti.UI.createAlertDialog({message:"È necessaria una memoria esterna di appoggio per processare i dati prima dell'invio, ma il tuo disposito non sembra esserne munito.",ok:"Ok",title:"saveHer"}).show();return networkRectangle.setButtonStatus("Memorizza"),void(saveHer.stopExecution=!1)}var now=null,folderToStore=null,folderToStoreName=null,thumb=null,thumbFile=null;try{var checkdir=saveHer.root;checkdir.exists()||checkdir.createDirectory(),now=new Date;var jData={day:now.getDate(),month:now.getMonth(),hour:now.getHours(),minute:now.getMinutes(),year:now.getFullYear(),address:""};folderToStoreName=""+now.getDate()+now.getMonth()+now.getHours()+now.getMinutes()+now.getFullYear(),folderToStore=Titanium.Filesystem.getFile(checkdir.getNativePath()+"/"+folderToStoreName),folderToStore.createDirectory();var jDateFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/date.json");if(reportRectangle.isFirstImagePresent()?(tempFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/1.jpg"),thumbFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/t_1.jpg"),newBlob=imagefactory.compress(reportRectangle.getFirstBigLayer(),.15),thumb=imagefactory.imageAsThumbnail(newBlob,{size:120}),tempFile.write(newBlob),thumbFile.write(thumb),jData.img1=tempFile.getNativePath(),jData.thumb1=thumbFile.getNativePath()):(jData.img1="",jData.thumb1=""),reportRectangle.isSecondImagePresent()?(tempFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/2.jpg"),thumbFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/t_2.jpg"),newBlob=imagefactory.compress(reportRectangle.getSecondBigLayer(),.15),thumb=imagefactory.imageAsThumbnail(newBlob,{size:120}),tempFile.write(newBlob),thumbFile.write(thumb),jData.img2=tempFile.getNativePath(),jData.thumb2=thumbFile.getNativePath()):(jData.img2="",jData.thumb2=""),reportRectangle.isThirdImagePresent()?(tempFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/3.jpg"),thumbFile=Titanium.Filesystem.getFile(folderToStore.getNativePath()+"/t_3.jpg"),newBlob=imagefactory.compress(reportRectangle.getThirdBigLayer(),.15),thumb=imagefactory.imageAsThumbnail(newBlob,{size:120}),tempFile.write(newBlob),thumbFile.write(thumb),jData.img3=tempFile.getNativePath(),jData.thumb3=thumbFile.getNativePath()):(jData.img3="",jData.thumb3=""),location.hasGPSDone){if(Ti.API.info("here"),jData.latitude=gpsRectangle.getLat(),jData.longitude=gpsRectangle.getLon(),jData.address=location.reverseGeocodingRequest,Titanium.Network.getOnline()){var url="http://maps.google.com/maps/api/geocode/json?latlng="+jData.latitude+","+jData.longitude+"&sensor=true";xhr=Titanium.Network.createHTTPClient(),xhr.open("GET",url),xhr.onload=function(){var json=this.responseText,gotitems=eval("("+json+")");""!=gotitems.results&&(jData.address=gotitems.results[0].address_components[2].long_name),jDateFile.write(JSON.stringify(jData)),networkRectangle.setButtonStatus("Fatto");var mainPage=new MainPage;mainPage.open(),networkRectangle.removeInterval(),location.removeGPSEvent(),self.close(),saveHer.stopExecution=!1},xhr.onerror=function(){Ti.API.info("here2"),jData.address="",jDateFile.write(JSON.stringify(jData)),networkRectangle.setButtonStatus("Fatto"),networkRectangle.setButtonStatus("Memorizza");var e=new MainPage;e.open(),networkRectangle.removeInterval(),location.removeGPSEvent(),self.close(),saveHer.stopExecution=!1},xhr.send()}}else{Ti.API.info("here3"),jData.latitude="",jData.longitude="",Ti.API.info(JSON.stringify(jData)),jDateFile.write(JSON.stringify(jData)),networkRectangle.setButtonStatus("Fatto!");var mainPage=new MainPage;mainPage.open(),networkRectangle.removeInterval(),location.removeGPSEvent(),saveHer.stopExecution=!1,self.close()}}catch(ex){var dialog=Ti.UI.createAlertDialog({message:"Sembra ci sia stato un problema nella memorizzazione dei files. Controlla lo spazio libero sulla tua SDCard.",ok:"Ok",title:"saveHer"}).show();Ti.API.info(ex),networkRectangle.setButtonStatus("Memorizza"),saveHer.stopExecution=!1}}},self}module.exports=Listeners;